
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเบิกวัสดุด้วย QR Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Prompt', sans-serif;
        }
        
        .bg-gradient {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }
        
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            transform: translateY(-1px);
        }
        
        .alert-item {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        
        .tab-active {
            color: #1e40af;
            border-bottom: 3px solid #1e40af;
        }
        
        .loader {
            border-top-color: #3b82f6;
            animation: spinner 0.6s linear infinite;
        }
        
        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-gradient text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ระบบเบิกวัสดุ</h1>
            <div class="flex items-center space-x-2">
                <span id="currentDate" class="text-sm"></span>
                <span id="currentTime" class="text-sm"></span>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left Column -->
            <div class="w-full md:w-2/3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex border-b border-gray-200 mb-4">
                        <button id="tab-requisition" class="tab-active py-2 px-4 font-medium text-lg">เบิกวัสดุ</button>
                        <button id="tab-history" class="py-2 px-4 font-medium text-lg text-gray-500">ประวัติการเบิก</button>
                    </div>
                    
                    <div id="requisition-form" class="space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="w-full md:w-1/2">
                                <label class="block text-gray-700 font-medium mb-2">รหัสวัสดุ</label>
                                <div class="flex">
                                    <input type="text" id="materialCode" class="w-full border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="กรอกรหัสวัสดุ">
                                    <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 transition">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="w-full md:w-1/2">
                                <label class="block text-gray-700 font-medium mb-2">ชื่อวัสดุ</label>
                                <input type="text" id="materialName" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ชื่อวัสดุ" readonly>
                            </div>
                        </div>
                        
                        <d class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                             <label>เลขที่ใบงาน:</label>
                            <input type="text" id="workOrderNo" placeholder="กรอกเลขที่ใบงาน" min="1" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-4 py-2 border" required>
                        
                            <label for="currentStock" class="block text-sm font-medium text-gray-700 mb-1">จำนวนในสต๊อก</label>
                            <input type="number" id="currentStock" name="currentStock" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-4 py-2 border bg-gray-100" readonly>
                        </div>
                            <div>
                            <label for="requestAmount" class="block text-sm font-medium text-gray-700 mb-1">จำนวนที่ต้องการเบิก</label>
                            <input type="number" id="requestAmount" name="requestAmount" min="1" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-4 py-2 border" required>
                        </div>
                        <div>
                            <label for="remainingStock" class="block text-sm font-medium text-gray-700 mb-1">จำนวนคงเหลือ</label>
                            <input type="number" id="remainingStock" name="remainingStock" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-4 py-2 border bg-gray-100" readonly>
                        </div>
                        </div>
                        
                        <div class="flex justify-between items-center mt-6">
                            <button id="scanQRBtn" class="flex items-center bg-gradient-to-r from-blue-600 to-blue-800 text-white px-6 py-2 rounded-lg hover:from-blue-700 hover:to-blue-900 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                </svg>
                                สแกน QR Code
                            </button>
                            <button id="submitBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">บันทึกการเบิก</button>
                        </div>
                    </div>
                    
                    <div id="history-content" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">วันที่</th>
                                        <th class="py-2 px-4 border-b text-left">รหัสวัสดุ</th>
                                        <th class="py-2 px-4 border-b text-left">ชื่อวัสดุ</th>
                                        <th class="py-2 px-4 border-b text-left">จำนวนที่เบิก</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div id="qrScannerContainer" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">สแกน QR Code</h2>
                        <button id="closeQRScanner" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div id="qrReader" class="w-full"></div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="w-full md:w-1/3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        วัสดุใกล้หมด
                    </h2>
                    <div id="lowStockItems" class="space-y-3">
                        <!-- Low stock items will be populated here -->
                        <div class="flex justify-center items-center py-8">
                            <div class="loader h-8 w-8 rounded-full border-4 border-gray-200"></div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">สถิติการเบิก</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">วันนี้</span>
                            <span id="todayCount" class="font-semibold">0 รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">สัปดาห์นี้</span>
                            <span id="weekCount" class="font-semibold">0 รายการ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">เดือนนี้</span>
                            <span id="monthCount" class="font-semibold">0 รายการ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 transform translate-y-full opacity-0 transition-all duration-300 flex items-center max-w-xs z-50">
        <div id="toastIcon" class="mr-3 text-green-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <div>
            <p id="toastMessage" class="text-sm font-medium text-gray-900">บันทึกข้อมูลสำเร็จ</p>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader h-12 w-12 rounded-full border-4 border-gray-200 mb-4"></div>
            <p class="text-gray-700">กำลังดำเนินการ...</p>
        </div>
    </div>

    <script>
        // DOM Elements
        const materialCodeInput = document.getElementById('materialCode');
        const materialNameInput = document.getElementById('materialName');
        const stockQuantityInput = document.getElementById('stockQuantity');
        const requestQuantityInput = document.getElementById('requestQuantity');
        const searchBtn = document.getElementById('searchBtn');
        const submitBtn = document.getElementById('submitBtn');
        const scanQRBtn = document.getElementById('scanQRBtn');
        const closeQRScanner = document.getElementById('closeQRScanner');
        const qrScannerContainer = document.getElementById('qrScannerContainer');
        const tabRequisition = document.getElementById('tab-requisition');
        const tabHistory = document.getElementById('tab-history');
        const requisitionForm = document.getElementById('requisition-form');
        const historyContent = document.getElementById('history-content');
        const historyTableBody = document.getElementById('historyTableBody');
        const lowStockItems = document.getElementById('lowStockItems');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const currentDateElement = document.getElementById('currentDate');
        const currentTimeElement = document.getElementById('currentTime');
        
        // Google Sheet API endpoint
        const API_URL = 'https://script.google.com/macros/s/AKfycbyWky_U0q4bpiUccL3nUJBQQsj7_xQbVvut1-XK3NT2BC07PKQzBN3rgz4XIIC4okGtag/exec';

       function fetchStockData() {
        fetch("https://script.google.com/macros/s/AKfycbyWky_U0q4bpiUccL3nUJBQQsj7_xQbVvut1-XK3NT2BC07PKQzBN3rgz4XIIC4okGtag/exec")
        .then(response => response.json())
        .then(data => console.log(data));
       }
        // Initialize date and time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateElement.textContent = now.toLocaleDateString('th-TH', options);
            currentTimeElement.textContent = now.toLocaleTimeString('th-TH');
        }
        
        updateDateTime();
        setInterval(updateDateTime, 1000);

             
        // Material data cache
        let materialDataCache = [];
        let historyDataCache = [];
        
        // Mock data for testing (will be replaced with actual API calls)
       //const mockMaterials = [
        //    { code: 'M001', name: 'กระดาษ A4', stock: 30 },
        //    { code: 'M002', name: 'ปากกาลูกลื่น', stock: 70 },
        //    { code: 'M003', name: 'แฟ้มเอกสาร', stock: 27 },
       //     { code: 'M004', name: 'ลวดเย็บกระดาษ', stock: 35 },
       //     { code: 'M005', name: 'คลิปหนีบกระดาษ', stock: 45 },
        //    { code: 'M006', name: 'กรรไกร', stock: 13 },
        //    { code: 'M007', name: 'เทปกาว', stock: 20 },
        //    { code: 'M008', name: 'ยางลบ', stock: 45 },
        //    { code: 'M009', name: 'ดินสอ', stock: 80 },
        //    { code: 'M010', name: 'ไม้บรรทัด', stock: 20 }
        //];
        
        //const mockHistory = [
         //   { date: '2023-06-05', code: 'M001', name: 'กระดาษ A4', quantity: 5 },
         //   { date: '2023-06-06', code: 'M002', name: 'ปากกาลูกลื่น', quantity: 10 },
         //   { date: '2023-06-07', code: 'M003', name: 'แฟ้มเอกสาร', quantity: 3 },
         //   { date: '2023-06-10', code: 'M001', name: 'กระดาษ A4', quantity: 10 },
         //   { date: '2023-06-12', code: 'M004', name: 'ลวดเย็บกระดาษ', quantity: 5 },
          //  { date: '2023-06-15', code: 'M005', name: 'คลิปหนีบกระดาษ', quantity: 15 },
           // { date: '2023-06-18', code: 'M002', name: 'ปากกาลูกลื่น', quantity: 20 },
          //  { date: '2023-06-20', code: 'M006', name: 'กรรไกร', quantity: 2 },
          //  { date: '2023-06-22', code: 'M007', name: 'เทปกาว', quantity: 5 },
          //  { date: '2023-06-25', code: 'M001', name: 'กระดาษ A4', quantity: 5 }
       // ];
        
        // Fetch material data from Google Sheet
        async function fetchMaterialData() {
            try {
                showLoading();
                
                // Try to fetch from API
                try {
                    const response = await fetch(`${API_URL}?action=getMaterials`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            materialDataCache = data.materials || [];
                            console.log("API data loaded successfully:", materialDataCache);
                        } else {
                            throw new Error(data.message || 'Failed to fetch material data');
                        }
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (apiError) {
                    console.warn("API fetch failed, using mock data:", apiError);
                    // Fall back to mock data if API fails
                    materialDataCache = [...mockMaterials];
                }
            } catch (error) {
                console.error('Error in fetchMaterialData:', error);
                showToast('ไม่สามารถดึงข้อมูลวัสดุได้ ใช้ข้อมูลตัวอย่างแทน', 'error');
                materialDataCache = [...mockMaterials];
            } finally {
                loadLowStockItems();
                hideLoading();
            }
        }
        
        // Fetch history data from Google Sheet
        async function fetchHistoryData() {
            try {
                // Try to fetch from API
                try {
                    const response = await fetch(`${API_URL}?action=getHistory`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            historyDataCache = data.history || [];
                            console.log("API history loaded successfully:", historyDataCache);
                        } else {
                            throw new Error(data.message || 'Failed to fetch history data');
                        }
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (apiError) {
                    console.warn("API history fetch failed, using mock data:", apiError);
                    // Fall back to mock data if API fails
                    historyDataCache = [...mockHistory];
                }
            } catch (error) {
                console.error('Error in fetchHistoryData:', error);
                historyDataCache = [...mockHistory];
            } finally {
                if (historyContent.classList.contains('hidden') === false) {
                    loadHistoryData();
                }
                updateStatistics();
            }
        }
        
        // Tab switching
        tabRequisition.addEventListener('click', () => {
            tabRequisition.classList.add('tab-active');
            tabRequisition.classList.remove('text-gray-500');
            tabHistory.classList.remove('tab-active');
            tabHistory.classList.add('text-gray-500');
            requisitionForm.classList.remove('hidden');
            historyContent.classList.add('hidden');
        });
        
        tabHistory.addEventListener('click', () => {
            tabHistory.classList.add('tab-active');
            tabHistory.classList.remove('text-gray-500');
            tabRequisition.classList.remove('tab-active');
            tabRequisition.classList.add('text-gray-500');
            requisitionForm.classList.add('hidden');
            historyContent.classList.remove('hidden');
            fetchHistoryData();
        });
        
        // Search material by code
        searchBtn.addEventListener('click', () => {
            const code = materialCodeInput.value.trim();
            if (code) {
                findMaterial(code);
            } else {
                showToast('กรุณาระบุรหัสวัสดุ', 'error');
            }
        });
        
        materialCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const code = materialCodeInput.value.trim();
                if (code) {
                    findMaterial(code);
                } else {
                    showToast('กรุณาระบุรหัสวัสดุ', 'error');
                }
            }
        });
        
        // Find material by code
        function findMaterial(code) {
            console.log("Searching for material with code:", code);
            console.log("Available materials:", materialDataCache);
            
            const material = materialDataCache.find(item => item.code === code);
            if (material) {
                materialNameInput.value = material.name;
                stockQuantityInput.value = material.stock;
                requestQuantityInput.value = '1';
                requestQuantityInput.max = material.stock;
                requestQuantityInput.focus();
            } else {
                materialNameInput.value = '';
                stockQuantityInput.value = '';
                requestQuantityInput.value = '';
                showToast('ไม่พบรหัสวัสดุนี้', 'error');
            }
        }
        
        // Submit requisition
        submitBtn.addEventListener('click', async () => {
            const code = materialCodeInput.value.trim();
            const name = materialNameInput.value.trim();
            const stockStr = stockQuantityInput.value.trim();
            const requestQtyStr = requestQuantityInput.value.trim();
            
            if (!code || !name) {
                showToast('กรุณาระบุรหัสวัสดุ', 'error');
                return;
            }
            
            if (!requestQtyStr) {
                showToast('กรุณาระบุจำนวนที่ต้องการเบิก', 'error');
                return;
            }
            
            const stock = parseInt(stockStr);
            const requestQty = parseInt(requestQtyStr);
            
            if (isNaN(stock) || isNaN(requestQty)) {
                showToast('จำนวนต้องเป็นตัวเลขเท่านั้น', 'error');
                return;
            }
            
            if (requestQty <= 0) {
                showToast('จำนวนที่ต้องการเบิกต้องมากกว่า 0', 'error');
                return;
            }
            
            if (requestQty > stock) {
                showToast('จำนวนที่ต้องการเบิกมากกว่าจำนวนในสต๊อก', 'error');
                return;
            }
            
            // Show loading overlay
            showLoading();
            
            // Prepare data for submission
            const data = {
                action: 'requisition',
                qrcode: code, // Using code as QR code for demonstration
                materialCode: code,
                materialName: name,
                stockQuantity: stock,
                requestQuantity: requestQty,
                remainingQuantity: stock - requestQty
            };
            
            console.log("Submitting data:", data);
            
            try {
                // Send data to Google Apps Script
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                    mode: 'cors',
                    cache: 'no-cache',
                });
                
                let result;
                
                if (response.ok) {
                    result = await response.json();
                    console.log("API response:", result);
                    
                    if (result.status === 'success') {
                        processSuccessfulRequisition(code, name, requestQty);
                        showToast('บันทึกการเบิกสำเร็จ', 'success');
                    } else {
                        throw new Error(result.message || 'Failed to submit requisition');
                    }
                } else {
                    console.warn("API submission failed, processing locally");
                    // If API fails, still update local data
                    processSuccessfulRequisition(code, name, requestQty);
                    showToast('บันทึกการเบิกสำเร็จ (โหมดออฟไลน์)', 'success');
                }
            } catch (error) {
                console.error('Error submitting requisition:', error);
                // Even if API fails, update local data for better UX
                processSuccessfulRequisition(code, name, requestQty);
                showToast('บันทึกการเบิกสำเร็จ (โหมดออฟไลน์)', 'success');
            } finally {
                // Hide loading overlay
                hideLoading();
            }
        });
        
        // Process successful requisition
        function processSuccessfulRequisition(code, name, requestQty) {
            // Update local cache
            const materialIndex = materialDataCache.findIndex(item => item.code === code);
            if (materialIndex !== -1) {
                materialDataCache[materialIndex].stock -= requestQty;
            }
            
            // Add to history cache
            const today = new Date().toISOString().split('T')[0];
            historyDataCache.unshift({
                date: today,
                code: code,
                name: name,
                quantity: requestQty
            });
            
            // Clear form
            materialCodeInput.value = '';
            materialNameInput.value = '';
            stockQuantityInput.value = '';
            requestQuantityInput.value = '';
            
            // Update low stock items
            loadLowStockItems();
            updateStatistics();
            
            // Focus on material code input for next entry
            materialCodeInput.focus();
        }
        
        // QR Code Scanner
        scanQRBtn.addEventListener('click', () => {
            qrScannerContainer.classList.remove('hidden');
            initQRScanner();
        });
        
        closeQRScanner.addEventListener('click', () => {
            qrScannerContainer.classList.add('hidden');
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(error => {
                    console.error("Error stopping QR scanner:", error);
                });
            }
        });
        
        let html5QrCode;
        
        function initQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(error => {
                    console.error("Error stopping QR scanner:", error);
                });
            }
            
            html5QrCode = new Html5Qrcode("qrReader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).catch(err => {
                console.error("Error starting QR scanner:", err);
                showToast('ไม่สามารถเริ่มการสแกน QR Code ได้', 'error');
            });
        }
        
        function onScanSuccess(decodedText) {
            // Stop scanning
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(error => {
                    console.error("Error stopping QR scanner:", error);
                });
            }
            
            // Close QR scanner
            qrScannerContainer.classList.add('hidden');
            
            // Set the scanned code and search
            materialCodeInput.value = decodedText;
            findMaterial(decodedText);
        }
        
        function onScanFailure(error) {
            // Handle scan failure if needed
            console.warn(`QR scan error: ${error}`);
        }
        
        // Load history data
        function loadHistoryData() {
            historyTableBody.innerHTML = '';
            
            if (historyDataCache.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="py-4 px-4 text-center text-gray-500">ไม่พบประวัติการเบิก</td>
                `;
                historyTableBody.appendChild(row);
                return;
            }
            
            historyDataCache.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4 border-b">${formatDate(item.date)}</td>
                    <td class="py-2 px-4 border-b">${item.code}</td>
                    <td class="py-2 px-4 border-b">${item.name}</td>
                    <td class="py-2 px-4 border-b">${item.quantity}</td>
                `;
                historyTableBody.appendChild(row);
            });
        }
        
        // Format date to Thai format
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString; // Return original if invalid
                }
                return date.toLocaleDateString('th-TH');
            } catch (error) {
                console.error("Error formatting date:", error);
                return dateString;
            }
        }
        
        // Load low stock items
        function loadLowStockItems() {
            lowStockItems.innerHTML = '';
            
            const lowItems = materialDataCache.filter(item => item.stock <= 10);
            
            if (lowItems.length === 0) {
                lowStockItems.innerHTML = `
                    <div class="py-4 text-center text-gray-500">ไม่มีวัสดุที่ใกล้หมด</div>
                `;
                return;
            }
            
            lowItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center p-3 border rounded-lg';
                
                // Add color based on stock level
                if (item.stock <= 3) {
                    itemElement.classList.add('bg-red-50', 'border-red-200', 'alert-item');
                } else if (item.stock <= 7) {
                    itemElement.classList.add('bg-yellow-50', 'border-yellow-200');
                } else {
                    itemElement.classList.add('bg-blue-50', 'border-blue-200');
                }
                
                itemElement.innerHTML = `
                    <div>
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-600">${item.code}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${item.stock <= 3 ? 'text-red-600' : item.stock <= 7 ? 'text-yellow-600' : 'text-blue-600'}">${item.stock}</p>
                        <p class="text-xs text-gray-500">คงเหลือ</p>
                    </div>
                `;
                
                // Add click event to quickly select this item
                itemElement.addEventListener('click', () => {
                    materialCodeInput.value = item.code;
                    findMaterial(item.code);
                    
                    // Switch to requisition tab if on history
                    if (historyContent.classList.contains('hidden') === false) {
                        tabRequisition.click();
                    }
                });
                
                itemElement.style.cursor = 'pointer';
                lowStockItems.appendChild(itemElement);
            });
        }
        
        // Update statistics
        function updateStatistics() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Filter for today's items
                const todayItems = historyDataCache.filter(item => {
                    try {
                        return item.date === today;
                    } catch (e) {
                        return false;
                    }
                });
                
                // Get start of week (Sunday)
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                
                // Get start of month
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                // Filter for week and month
                const weekItems = historyDataCache.filter(item => {
                    try {
                        return new Date(item.date) >= startOfWeek;
                    } catch (e) {
                        return false;
                    }
                });
                
                const monthItems = historyDataCache.filter(item => {
                    try {
                        return new Date(item.date) >= startOfMonth;
                    } catch (e) {
                        return false;
                    }
                });
                
                document.getElementById('todayCount').textContent = `${todayItems.length} รายการ`;
                document.getElementById('weekCount').textContent = `${weekItems.length} รายการ`;
                document.getElementById('monthCount').textContent = `${monthItems.length} รายการ`;
            } catch (error) {
                console.error("Error updating statistics:", error);
                document.getElementById('todayCount').textContent = "0 รายการ";
                document.getElementById('weekCount').textContent = "0 รายการ";
                document.getElementById('monthCount').textContent = "0 รายการ";
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toastIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                `;
            } else {
                toastIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                `;
            }
            
            // Clear any existing timeout
            if (window.toastTimeout) {
                clearTimeout(window.toastTimeout);
            }
            
            // Show toast
            toast.classList.remove('translate-y-full', 'opacity-0');
            
            // Hide toast after delay
            window.toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }
        
        // Show loading overlay
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }
        
        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
        
        // Debug function to test API connectivity
        async function testAPIConnection() {
            try {
                console.log("Testing API connection...");
                const response = await fetch(`${API_URL}?action=getMaterials`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache',
                });
                
                console.log("API Response Status:", response.status);
                const text = await response.text();
                console.log("API Response Text:", text);
                
                try {
                    const json = JSON.parse(text);
                    console.log("API Response JSON:", json);
                } catch (e) {
                    console.log("Response is not valid JSON");
                }
            } catch (error) {
                console.error("API Connection Test Error:", error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Application initialized");
            testAPIConnection(); // Test API connectivity
            fetchMaterialData();
            fetchHistoryData();
            materialCodeInput.focus();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'943b52f6606da1c2',t:'MTc0NzkwNjUzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
